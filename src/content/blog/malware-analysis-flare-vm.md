---
title: "Malware Analysis Report Using Flare-VM"
description: "Deep dive into malware creation, execution, and analysis using Flare-VM."
pubDate: "Jan 10 2026"
tags: ["malware", "vm", "analysis", "flare-vm"]
heroImage: "/images/MalwareAnalysisFlareVM/24_virustotal_result.png"
---

# Malware Analysis Report Using Flare-VM

## Introduction

This report is compiled to fulfill the final assignment for the Malware Analysis module. The primary focus of this assignment is to simulate malware creation, execute it within a controlled environment (_sandbox_), and perform in-depth analysis to identify behaviors and Indicators of Compromise (_IOC_).

### Learning Objectives

Based on the assignment guidelines, the objectives to be achieved include:

1. **Malware Creation**: Ability to create _malicious software_ using industry-standard tools such as _msfvenom_.
2. **Sandbox Analysis**: Understanding the malware analysis process using a _sandbox_ environment, specifically Flare-VM in this case.
3. **IOC Identification**: Recognizing and identifying _IOCs_ generated from the malware execution.
4. **Mitigation**: Understanding the impact and objectives of the malware, and formulating appropriate mitigation recommendations.

### Methodology

The analysis is conducted using the _Dynamic Analysis_ method within Flare-VM. Unlike the guidelines which suggest using Any.Run or Joe Sandbox, this analysis is performed locally to gain deeper visibility into system changes in _real-time_ using various tools (and due to the lack of account access for Any.Run).

---

## Malware Creation

The first stage is the creation of a malicious _executable_ file. The tool used is **MSFVenom**, a combination of Metasploit _payloads_ and encryption. The list of available _payloads_ can be seen in the figure below.

<p align="center">
  <img src="/images/MalwareAnalysisFlareVM/01_msfvenom_list_payloads.png" width="80%" />
  <br>
  <i>Figure 1: List of payloads in MSFVenom</i>
</p>

### Payload Selection

The author searched for available _payloads_ for the target operating system (Windows). The selected _payload_ is `windows/meterpreter/reverse_https`. This _payload_ is commonly used to gain interactive _reverse shell_ access (Meterpreter) back to the attacker's machine via the HTTPS protocol to evade _firewall_ detection.

<p align="center">
  <img src="/images/MalwareAnalysisFlareVM/02_selected_payload.png" width="80%" />
  <br>
  <i>Figure 2: Windows payload selection</i>
</p>

### Configuration and Initialization

The author checked the IP addresses of the _host_ machine (attacker) and the target machine (Flare-VM) to ensure connectivity.

<p align="center">
  <img src="/images/MalwareAnalysisFlareVM/04_host_ip_address.png" width="80%" />
  <img src="/images/MalwareAnalysisFlareVM/05_vm_ip_address.png" width="80%" />
  <br>
  <i>Figure 3: IP Address Check - (Left) Host/Attacker, (Right) VM/Target</i>
</p>

- **LHOST**: IP address of the attacker's machine (Kali Linux).
- **LPORT**: Port used to listen for the incoming connection (_default_: 4444).

The malware was saved with the _executable_ name `ysrdh.exe`. The process of saving the successfully created file can be seen in the following figure. This creation process ensures that the file is ready to be distributed to the testing environment.

<p align="center">
  <img src="/images/MalwareAnalysisFlareVM/06_saving_malware.png" width="80%" />
  <br>
  <i>Figure 4: Saving the malware executable file</i>
</p>

---

## Execution and Exploitation

After the malware was successfully created, the next stage is to simulate an attack to observe how the malware interacts with the target system.

### Listener Preparation

The attacker prepares a _listener_ using the `multi/handler` module in _msfconsole_. The first step is to search for and select the appropriate module.

<p align="center">
  <img src="/images/MalwareAnalysisFlareVM/07_search_exploit_multi_handler_msfconsole.png" width="80%" />
  <br>
  <i>Figure 5: Searching for the multi/handler module</i>
</p>

The configuration is adjusted to match the previously used _payload_ (`windows/meterpreter/reverse_https`). The author sets `LHOST` and `LPORT` to match the configuration in the malware.

<p align="center">
  <img src="/images/MalwareAnalysisFlareVM/09_use_exploit_and_set_payload.png" width="80%" />
  <img src="/images/MalwareAnalysisFlareVM/10_set_options_msfconsole.png" width="80%" />
  <br>
  <i>Figure 6: Listener Configuration - Set Payload and Options</i>
</p>

The _listener_ is then executed.

<p align="center">
  <img src="/images/MalwareAnalysisFlareVM/12_running_listener_msfconsole.png" width="80%" />
  <br>
  <i>Figure 7: Running the listener in msfconsole</i>
</p>

### Malware Distribution

The `ysrdh.exe` file is sent to the target machine via a simple HTTP server using a Python module.

<p align="center">
  <img src="/images/MalwareAnalysisFlareVM/11_serving_the_file_via_http_server.png" width="80%" />
  <br>
  <i>Figure 8: Running HTTP Server for distribution</i>
</p>

On the target side (Flare-VM), the file is downloaded via a _browser_. Windows Defender detects this threat, but the file is kept (_allowed_) for analysis purposes.

<p align="center">
  <img src="/images/MalwareAnalysisFlareVM/13_accessing_host_server_windows.png" width="60%" />
  <img src="/images/MalwareAnalysisFlareVM/14_windows_defender_warning.png" width="60%" />
  <img src="/images/MalwareAnalysisFlareVM/15_keep_file.png" width="60%" />
  <br>
  <i>Figure 9: Download process on the victim's side - Access, Warning, and Keep File</i>
</p>

Finally, the file is successfully downloaded.

<p align="center">
  <img src="/images/MalwareAnalysisFlareVM/17_downloaded_file.png" width="60%" />
  <br>
  <i>Figure 10: Malware file successfully landed on the target system</i>
</p>

### Successful Exploitation

Once the file is executed, the connection is successfully received by the attacker's machine. The open Meterpreter session provides full access to the target system, allowing the attacker to execute _shell_ commands, retrieve system information, and perform data _exfiltration_.

<p align="center">
  <img src="/images/MalwareAnalysisFlareVM/18_im_in.png" width="80%" />
  <br>
  <i>Figure 11: Active Meterpreter Session (Reverse HTTPS)</i>
</p>

---

## Malware Analysis (Dynamic Analysis)

The analysis is conducted within the isolated Flare-VM environment to monitor malware behavior in _real-time_.

### Post-Exploitation Activity

After obtaining the Meterpreter session, the first step is to collect system information (`sysinfo`) and gain _shell_ access.

<p align="center">
  <img src="/images/MalwareAnalysisFlareVM/19_System_Info_Meterpreter.png" width="80%" />
  <img src="/images/MalwareAnalysisFlareVM/20_shell.png" width="80%" />
  <br>
  <i>Figure 12: Initial interaction - System Info and Shell Access</i>
</p>

To maintain _persistence_ and avoid easy detection, the malware process can be migrated to a legitimate system process (such as `explorer.exe` or `notepad.exe`).

> [!TIP]
> **Target migration process:** To target a process for injection, we must target a process with an architecture that matches our _payload_. In this case, our _payload_ has a 32-bit (x86) architecture, so we must target a 32-bit (x86) process as well.

<p align="center">
  <img src="/images/MalwareAnalysisFlareVM/23_migrate_success.png" width="80%" />
  <br>
  <i>Figure 13: Process migration to matching x86 architecture</i>
</p>

### In-Depth File Reputation Analysis (VirusTotal)

The sample file `ysrdh.exe` (SHA-256: `e70b7ee1...0ecbc8`) was uploaded to VirusTotal for static and dynamic analysis. The results show a high detection rate and suspicious behavior.

<p align="center">
  <img src="/images/MalwareAnalysisFlareVM/24_virustotal_result.png" width="90%" />
  <br>
  <i>Figure 14: Initial detection results on VirusTotal (High Detection Rate)</i>
</p>

#### Identification and Context

In-depth analysis of the _Details_ tab on VirusTotal reveals several key anomalies that define the origin and technical profile of this sample.

<p align="center">
  <img src="/images/MalwareAnalysisFlareVM/40_virustotal_details.png" width="90%" />
  <br>
  <i>Figure 15: File property details on VirusTotal</i>
</p>

Here is a detailed breakdown of these findings:

1. **Indicator of _Patient Zero_**: The submission history shows that the _First Submission_ and _Last Submission_ are identical (`2026-01-08 08:53:17 UTC`). This indicates that `ysrdh.exe` is a completely new file to VirusTotal and has never been seen before in the global _database_. The author acts as "_patient zero_" or the first source of this file.
2. **File Name and OpSec Failure**: In the _Names_ section, only one name is listed: `ysrdh.exe`. The absence of _random_ name variations or disguises (such as `invoice.exe`) strengthens the evidence that this file is not widely distributed on the internet (_in the wild_) but is a local laboratory artifact. The use of this unique name facilitates the creation of detection _signatures_ by _antivirus_ vendors.
3. **File Type and Size Anomaly**: With a size of only 7.50 KB, this file is too small to be a legitimate functional application. TrID analysis shows confusion between _Win32 Dynamic Link Library_ (27.1%) and _Win32 Executable_ (18.6%). These characteristics are identical to the profile of a **_stager_** or _shellcode runner_ designed specifically to fetch the main _payload_ from the attacker's server.
4. **Compilation Time Gap**: There is a time difference of about five months between the creation time (_Creation Time_: 2025-08-28) and the upload time (2026-01-08). This indicates that this _software_ may have been stored or used limitedly in an offline environment before finally being uploaded for analysis.

> [!IMPORTANT]
> **Compilation Time Anomaly: Technical Fact vs. Assumption:** This time difference actually reveals how `msfvenom` works. The tool does not recompile C code every time it runs, but rather performs _patching_ on an existing _template binary_. The date `2025-08-28` is the original compilation time of the Metasploit _template_ by its developers, not the time `ysrdh.exe` was created. For the defense team (_Blue Team_), this is a very clear _Static Indicator of Compromise (IoC)_. This metadata directly leaks that the file is an automatically generated _payload_ from Metasploit, without needing further code analysis.

#### Malware DNA Identification (YARA Rules)

> [!NOTE]
> **What is YARA?** YARA is a tool designed to help malware researchers identify and classify malware samples. It works by matching patterns (such as text _strings_, binary sequences, or PE _header_ characteristics) defined in specific rules against the file being analyzed.

Analysis using YARA rules provides more specific identification regarding the _tools_ used. Detections of `Windows_Trojan_Metasploit` and `CobaltStrikeStager` confirm that this sample is a **_Stager_**. Both _frameworks_ use similar "_Reflective DLL Injection_" techniques and API _hashing_, which trigger these detection rules. Additionally, the rule `INDICATOR_SUSPICIOUS_EXE_NoneWindowsUA` indicates that the malware spoofs the _User-Agent_ when making network connections to evade _firewall_ detection.

<p align="center">
  <img src="/images/MalwareAnalysisFlareVM/45_virustotal_yara_rules.png" width="90%" />
  <br>
  <i>Figure 16: Malware DNA identification via YARA rules</i>
</p>

#### Behavioral Analysis

Activity logs show patterns consistent with evasion attempts and C2 communication.

1. **Network Configuration and Obfuscation**
   The sample's behavior includes _Obfuscated Files or Information_ (T1027) techniques and the use of _Application Layer Protocol_ (T1071) such as HTTP/S to disguise C2 traffic. Inspection of _proxy_ (`ProxyHttp1.1`) and _requests_ to Internet Explorer (IE) _registry keys_ such as `FEATURE_MIME_HANDLING` shows attempts to ensure outbound connections succeed, even in _hardened_ environments.

   <p align="center">
     <img src="/images/MalwareAnalysisFlareVM/41_virustotal_behaviors.png" width="90%" />
     <br>
     <i>Figure 17: T1027 (Obfuscation) and T1071 (C2 Protocol) techniques</i>
   </p>

2. **Call Home Signals and Sandbox Noise**
   Analysis of _registry keys_ (`ProxyEnable`, `WpadDecision`) confirms the sample's main function as a _network connector_. The sample immediately attempts to make a network connection after execution, triggering the Windows OS to check _proxy_ settings (WPAD). This behavior is typical for a _reverse shell_ or _stager_ attempting to contact a C2 server.

> [!NOTE]
> **Note on Sandbox Noise:** The list of "_Processes Terminated_" (such as `w32time` or _Windows Telemetry_) is likely _sandbox noise_ or routine operating system cleanup activity, not the result of malware action. The absence of system processes (such as `schtasks.exe`) in the "_Processes Created_" list proves that `ysrdh.exe` does not actively terminate those services. This sample runs independently (_naked_) without trying to inject itself (_injection_) into other processes at this stage.

A complete visualization of these _registry_ and process activities is presented in the following figure.

<p align="center">
  <img src="/images/MalwareAnalysisFlareVM/42_virustotal_behaviors_registry_and_process.png" width="90%" />
  <br>
  <i>Figure 18: Registry modification to lower system security levels</i>
</p>

#### Infrastructure and Relation Analysis

The _Relations_ and _Bundled Files_ tabs provide the final piece of the puzzle regarding the origin and structure of this sample. These findings confirm the file's status as a laboratory product that is less tidy in terms of _Operational Security (OpSec)_.

<p align="center">
  <img src="/images/MalwareAnalysisFlareVM/43_virustotal_relations.png" width="90%" />
  <br>
  <i>Figure 19: Relation graph showing connection to attacker's lab infrastructure</i>
</p>

Here is an in-depth analysis of these findings:

1. **Lab Environment Leak (IP 192.168.56.1)**: The sample was detected trying to contact IP address `192.168.56.1`. This is not a _random_ IP, but the _default_ address for the _Host-Only Adapter_ in VirtualBox. This proves that this _payload_ was created inside a VM (likely Kali Linux) with the target _listener_ on the _host_ machine. Although using this private IP prevents public C2 infrastructure leaks, it also renders this malware useless outside the author's specific _lab environment_.
2. **PE Structure Anomaly (`.nyhl` Section)**: Internal file structure analysis (_PE Sections_) shows the presence of a section named `.nyhl`. This section is a major anomaly because legitimate Windows _software_ (from Microsoft or major vendors) does not have section names like this. This _random_ 4-letter name is likely generated by the Metasploit _encoder_ (like _Shikata Ga Nai_) or other _packing_ techniques to obfuscate the _shellcode_. For security analysts, the existence of this non-standard section is an instant static indicator that the file has been modified or _packed_.

Overall, the combination of time metadata (_default_ template), anomalous structure (`.nyhl`), and "noisy" network behavior to a private IP confirms that `ysrdh.exe` is a standard Metasploit _stager_ without advanced _stealth_ modifications.

#### API Call Analysis (Jujubox Sandbox)

Technical data recorded in the Jujubox report provides an in-depth view of the malware initialization phase. By observing the _API calls_ and process arguments, the following behaviors can be deduced:

1. **Fingerprinting**: `GetAdaptersAddresses` calls are used to check network specifications, often aiming to detect _virtual machine_ environments or collect _host_ information.
2. **Anti-Analysis**: `GetTickCount` and `GetTickCount64` functions are used to calculate system _uptime_ or measure execution time differences to detect the presence of a _debugger_ or _sandbox_.
3. **Session Management**: The use of `CreateMutexA` and `NtCreateMutant` aims to mark the infection and ensure only one instance of the malware runs on the system.
4. **Persistence Attempts**: Calls to `RegCreateKeyEx`, `RegSetValueExW`, and `NtCreateKey` indicate modifications to system configuration or adding entries for _persistence_.
5. **Native API Usage**: Utilization of `Nt*` functions (_Native API_) shows attempts to operate at a lower level to avoid _hooking_ or _monitoring_ on standard Windows APIs.

The combination of these function calls strengthens the suspicion that `ysrdh.exe` acts as a **_stager_** or **_dropper_** performing _profiling_ against the target before proceeding to the final infection stage.

<p align="center">
  <img src="/images/MalwareAnalysisFlareVM/44_virustotal_jujubox.png" width="90%" />
  <br>
  <i>Figure 20: Jujubox sandbox analysis report showing API call sequence</i>
</p>

### System Monitoring

While the malware was running, the author monitored system activity using various _tools_:

#### Task Manager

The malware process is visible running in Task Manager, consuming CPU and memory _resources_.

<p align="center">
  <img src="/images/MalwareAnalysisFlareVM/26_malware_task_manager.png" width="70%" />
  <br>
  <i>Figure 21: Trace of ysrdh.exe process in Task Manager</i>
</p>

#### Process Monitor (Procmon)

The first step is to run Process Monitor (Procmon) and apply a filter to monitor the `ysrdh.exe` process activity. After the malware activity is recorded, the capture result must be saved in CSV format for further analysis using ProcDot.

It is important to note that the _default_ CSV format from Procmon often fails to be read by ProcDot, causing error messages.

<p align="center">
  <img src="/images/MalwareAnalysisFlareVM/35_procmon_error_format.png" width="70%" />
  <br>
  <i>Figure 22: Error when loading default Procmon CSV file into ProcDot</i>
</p>

To resolve this issue, the **Thread ID** column must be enabled before saving the log. This configuration can be done via the `Options -> Select Columns` menu and checking the "Thread ID" option.

<p align="center">
  <img src="/images/MalwareAnalysisFlareVM/36_set_categories_procmon.png" width="80%" />
  <img src="/images/MalwareAnalysisFlareVM/37_enable_thread_id_procmon.png" width="80%" />
  <br>
  <i>Figure 23: Procmon column configuration for visualization compatibility</i>
</p>

After the log is saved in the correct format, the CSV file can be loaded into ProcDot. The next step is to select the malware process to be analyzed from the available process list.

<p align="center">
  <img src="/images/MalwareAnalysisFlareVM/38_choose_processs.png" width="60%" />
  <br>
  <i>Figure 24: Choosing the malware process in ProcDot</i>
</p>

#### Wireshark

Wireshark captures data _traffic_ showing _outbound_ connection attempts to the attacker's IP address on port 8080.

<p align="center">
  <img src="/images/MalwareAnalysisFlareVM/29_running_wireshark.png" width="90%" />
  <br>
  <i>Figure 25: Network traffic capture with Wireshark</i>
</p>

### Visualization with ProcDot

To facilitate understanding of the execution flow, logs from Procmon (CSV) and Wireshark (PCAP) are exported and loaded into **ProcDot**.

<p align="center">
  <img src="/images/MalwareAnalysisFlareVM/32_procdot.png" width="80%" />
  <img src="/images/MalwareAnalysisFlareVM/39_graph_generated.png" width="80%" />
  <br>
  <i>Figure 26: Graph generation process using ProcDot</i>
</p>

A more detailed graph is generated by ProcDot, visualizing the interaction between the `ysrdh.exe` process, network connections to the attacker's IP, and system _registry_ modifications for _evasion_.

<p align="center">
  <img src="/images/MalwareAnalysisFlareVM/graph.png" width="90%" />
  <br>
  <i>Figure 27: Detailed interaction graph between process, network, and registry</i>
</p>

---

## Attack Timeline Reconstruction

Based on the dynamic analysis results, here is the attack _timeline_ reconstruction detailing the malware behavior from initial infection to _persistence_.

| Phase                | Actor           | Action                  | Threat Significance                                                     |
| :------------------- | :-------------- | :---------------------- | :---------------------------------------------------------------------- |
| 1. Initial Infection | `Explorer.EXE`  | _Process Creation_      | Executed `ysrdh.exe` from Downloads folder.                             |
| 2. Defense Evasion   | `ysrdh.exe`     | _Registry Modification_ | Modified `ZoneMap` to lower security settings.                          |
| 3. C2 Comm           | `ysrdh.exe`     | _Network Connection_    | TCP connection to 192.168.56.1 port 8080.                               |
| 4. Error/Crash       | `WerFault.exe`  | _File Activity_         | _Creates crash reports, indicating instability or injection attempts_.  |
| 5. Propagation       | `RuntimeBroker` | _Registry Modification_ | _Legitimate process modifies same registry keys, suggesting hijacking_. |
| 6. Persistence       | `DllHost.exe`   | _Network Connection_    | Active connection after process injection confirmed.                    |

---

## IOC and Conclusion

### IOC Identification

Based on the analysis performed, here are some of the _IOCs_ found:

| IOC Category        | Indicator Detail                                                   |
| :------------------ | :----------------------------------------------------------------- |
| File Name           | `ysrdh.exe`                                                        |
| Network Activity    | _Outbound_ connection to Port 8080 (HTTPS/TCP)                     |
| File Hash (SHA-256) | `e70b7ee1c014f99fd71e7ccd7983ccd1e96c64a5e0ae412cc33a719a920ecbc8` |
| Process Behavior    | Initiates network connection immediately after execution           |

### Conclusion

The analyzed malware is a _backdoor_ that provides full _remote_ access to the attacker. Although standard antivirus detection is quite effective against this _payload_, the use of appropriate delivery techniques can still compromise systems that are not updated or do not have strict network monitoring.

### Mitigation Recommendations

To minimize the risk of similar malware attacks, here are some suggested mitigation steps:

1. **Endpoint Protection**: Always use up-to-date antivirus or EDR (_Endpoint Detection and Response_) solutions and ensure _real-time_ protection features are active.
2. **Firewall Management**: Implement _egress filtering_ rules on the _firewall_ to limit outbound connections only to known and necessary IP addresses and ports.
3. **User Awareness**: Conduct periodic education for users regarding the dangers of downloading and executing files from untrusted sources or via suspicious links.
4. **Network Monitoring**: Use network traffic monitoring systems (IDS/IPS) to detect _reverse shell_ communication patterns or other anomalous activities.
